<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>Bench</title>
<link rel="stylesheet" href="/css/error.css" />
<style>
    h1 {color:steelblue}
</style>
<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
<script src="/javascripts/jquery/jquery-1.7.2.js"></script>
</head>
<body>
<h1>Kanopya service benchmark</h1>
<div id='instantiation' style="float:left">
    <h2>Service instantiation automation</h2>
    Number of instances : <input id="count" type='text'/>
    <br/>
    Service definition:
    <br/>
    <textarea id='service-template' rows="4" cols="50" title='azefze'>
    {"cluster_name":"bench_instance","cluster_desc":"","user_id":"65","service_template_id":"289","label":"","comment":"","active":"1","vg_id":"1","iscsi_portals":["1"],"cluster_basehostname":"gregre","deploy_on_disk":"0","interfaces":[{"interface_name":"interface1","netconfs":["142"],"bonds_number":""}],"components":[{"component_type":"77"},{"component_type":"39"}]}
    </textarea>
    <br/>
    <button onclick="launchInstantiation()">Launch</button>
    <div id="result"></div>
</div>
<div id="management" style="float:left">
    <h2>Instances management</h2>
    Filter: <input id="instance-filter" type='text' value="cluster_name=LIKE,bench_instance_%" style="width:80%"/>
    <br/>
    <button onclick="getInstances()">Get</button>
    <button onclick="activateInstances()">Activate all</button>
    <button onclick="startInstances()">Start all</button>
    <button onclick="stopInstances()">Stop all</button>
    <button onclick="deactivateInstances()">Deactivate all</button>
    <button onclick="deleteInstances()">Delete all</button>

    <br/>
    Total: <span id='result-count'>0</span>
    <br/>
    <table id="instance-list"></table>
</div>
<div id="profiling" style="float:left">
    <h2>Profiling</h2>
</div>
<div style="clear:both">
    <h1>How to</h1>
    This page allow to quickly and simply create and manipulate a group of service instances.<br/>
    Some profiling is done for informative purpose.
    <h2>Instanciate</h2>
    Allow automation of multiple instantiation of a service already manually instantiate once.
    <h3>procedure</h3>
    <ol>
        <li>Log in to Kanopya user interface</li>
        <li>Open the browser web development console (to see sent requests)</li>
        <li>Instantiate a service with your wanted configuration</li>
        <li>Look at the sent request 'POST api/cluster'</li>
        <li>Copy the transmitted data (Request Payload). Not the response data.</li>
        <li>Past the data in the 'Service definition' box of the bench page</li>
        <li>Check that the instance is correctly created and corresponds to your needs</li>
        <li>Fill the 'Number of instances' field</li>
        <li>Click on launch</li>
        <li>Request are listed and when everything is marked 'Done' you can start managing instances</li>

    </ol>
    <h3>What happens</h3>
    The bench script will send a post request to create as many instances as defined.<br/>
    The name of each instance is generated by taking the value of the "cluster_name" (in the "Service definition")
    and adding '_' followed by a time stamp.<br/>
    If the "cluster_name" is not in the "Service definition", the instances base name will be "bench_instance".<br/>
    You can then see the list of instances and the current state (request posted, instance created).

    <h3>Troubles shooting</h3>
    Some requests may be lost or some states not updated. Don't worry, it can happens.<br/>
    You can refresh the page when you want (only profiling will be lost) and see what is really created (and the state)
    by requesting instances using 'Filter' field in the "Instance management" part.<br/><br/>
    To avoid to overload the system too quickly, you can also create a small amount of instances (low 'Number of instances'),
    and if everything is good then click again on the 'Launch' button to create more instances, as many time you want.

    <h2>Manage</h2>
    The "Filter" field allow you to search all instances you want to manage.<br/>
    Click the 'Get' button and you can see the list of retrieved instances corresponding to the filter,
    each instance name is followed by the instance activation info and the instance state.<br/>
    Then you can click on one of the action buttons to apply action on all the listed instances.
</div>

<script>
    function launchInstantiation() {
        var template = $.parseJSON($('#service-template').val());
        var base_name = template.cluster_name ? template.cluster_name : "bench_instance";
        $('#instance-filter').val('cluster_name=LIKE,'+base_name+'_%');
        var count = parseFloat($('#count').val());
        var waiting_count = count;

        var profil_res = $('<span>', {text:'pending'});
        $('#profiling').append('instantiate ' + waiting_count + ' instances...')
                       .append(profil_res)
                       .append('<br/>');

        var posted = 0;
        while (count > 0) {
            var instance = template;
            var date_now = Date.now();
            var instance_name = base_name + '_' + date_now;
            instance.cluster_name = instance_name;
            instance.cluster_basehostname = date_now;
            $('#result').append($('<span>',{text:'Creating ' + instance_name + '...'}))
                        .append($('<span>', {id:instance_name})).append('<br>');
            function instantiate(){
                var name = instance.cluster_name;
                console.log('post ' +name);
                $.ajax({
                    type        : 'POST',
                    url         : '/api/cluster',
                    data        : JSON.stringify(instance),
                    contentType    : 'application/json',
                    success     : function() {
                        console.log(name + ' posted');
                        $('#'+name).text('posted...');
                        posted++;
                    },
                    error       : function(xhr, status, error) {
                        console.log(error);
                        $('#'+name).text(error);
                    }
                });
                count--;
            }
            instantiate();
        }

        // Wait until all services instantiated
        var start = Date.now();
        var created = 0;
        var update_state = setInterval(function(){
            $.get('/api/cluster?cluster_name=LIKE,'+base_name+'_%', function(data){
                $(data).each(function(){
                    var instance_elem = $('#'+this.cluster_name);
                    if (instance_elem.length > 0 && instance_elem.text() !== 'Done') {
                        instance_elem.css('color', 'green');
                        instance_elem.text('Done');
                        created++;
                    }
                });
                if (created == posted) {
                    var time = Date.now() - start;
                    profil_res.text(time + 'ms ('+Math.round(time/waiting_count)+'/instance)');
                    clearInterval(update_state);
                }
            });
        }, 5000);
    }

    function _wait_result(params) {
        $('*').css('cursor','wait');
        var done_count = 0;
        $('.instance').removeClass('done');
        var instance_filter = $('#instance-filter').val();
        var waiter = setInterval(function() {
            $('.instance').addClass('delete-flag');
            $.get('/api/cluster?'+instance_filter, function(data){
                $(data).each(function(){
                    var instance_elem = $('#'+this[params.key]).removeClass('delete-flag');
                    if (instance_elem.length > 0 && !instance_elem.hasClass('done') && params.isDone(this)) {
                        instance_elem.addClass('done');
                        params.done(this);
                        done_count++;
                    }
                });
                var deleted = $('.delete-flag');
                done_count += deleted.length;
                deleted.remove();
                if (done_count == params.wainting_count) {
                    $('*').css('cursor','auto');
                    clearInterval(waiter);
                    params.allDone();
                }
            });
        }, 5000)
    }

    var instance_count = 0;

    function getInstances() {
        var instance_filter = $('#instance-filter').val();
        $('#instance-list').empty();
        $.get('/api/cluster?'+instance_filter, function(data){
            instance_count = $(data).length;
            $('#result-count').text(instance_count);
            $(data).each(function(){
                $('#instance-list').append(
                    $('<tr>', {id:this.pk, class:'instance'})
                    .append($('<td>',{text:this.cluster_name}))
                    .append($('<td>',{class:'instance-active', text:parseFloat(this.active)?'activated':'deactivated'}))
                    .append($('<td>',{class:'instance-state', text:/(.*):.*/.exec(this.cluster_state)[1]}))
                );
            });
        });
    }

    function _insistent_call(type, url, try_count) {
        if (try_count==0) {return}
        $.ajax({
            type : type,
            url  : url,
            error: function() {
                try_count--;
                setTimeout(function(){
                    console.log('Retry ' + url + ' TRY : ' + try_count); 
                    _insistent_call(type, url, try_count);
                }, 500);
            }
        });
    }

    function _bulkAction(params) {
        var start = Date.now();
        $('.instance').css('color', 'black');
        var count = $('.instance').length
        var profil_res = $('<span>', {text:'pending'});
        $('#profiling').append(params.action + ' ' + count + ' instances...')
                       .append(profil_res)
                       .append('<br/>');

        $('.instance').each(function() {
            var url = '/api/cluster/'+this.id;
            if (params.type == 'POST') {url+='/'+params.action}
            _insistent_call(params.type,url, 10);
        });

        _wait_result({
            wainting_count  : count,
            key             : 'pk',
            isDone : params.isDone || function(obj) {
                return false;
            },
            done : params.done || function(obj) {},
            allDone : function() {
                var time = Date.now() - start;
                profil_res.text(time + 'ms ('+Math.round(time/instance_count)+'/instance)');
            }
        });
    }

    function _activation(active_state, method) {
        _bulkAction({
            action : method,
            type   : 'POST',
            isDone : function(obj) {
                return (obj.active == active_state);
            },
            done : function(obj) {
                $('#'+obj.pk).css('color','blue');
                $('#'+obj.pk+' .instance-active').text(parseFloat(obj.active)?'activated':'deactivated');
            },
        });
    }

    function deactivateInstances() {
        _activation(0, 'deactivate');
    }

    function activateInstances() {
        _activation(1, 'activate');
    }

    function deleteInstances() {
        _bulkAction({
            action : 'delete',
            type   : 'DELETE',
        });
    }

    function _manageStateFunction(initial_test, wanted_state) {
        return function(obj) {
            var state = /(.*):.*/.exec(obj.cluster_state)[1];
            var state_elem = $('#'+obj.pk+' .instance-state');
            if (state == initial_test && state != state_elem.text()) {
                state_elem.text(state).css('color', 'red');
                return true;
            } else {
                state_elem.text(state);
            }
            return (state == wanted_state);
        }
    }

    function startInstances() {
        _bulkAction({
            action : 'start',
            type   : 'POST',
            isDone : _manageStateFunction('down', 'up'),
        });
    }

    function stopInstances() {
        _bulkAction({
            action : 'stop',
            type   : 'POST',
            isDone : _manageStateFunction('up', 'down'),
        });
    }
</script>
</body>
</html>
